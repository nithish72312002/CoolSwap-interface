{"ast":null,"code":"import { useEffect } from 'react';\nimport { useDispatch, useSelector } from 'react-redux';\nimport { useActiveWeb3React } from '../../hooks';\nimport { useAddPopup, useBlockNumber } from '../application/hooks';\nimport { checkedTransaction, finalizeTransaction } from './actions';\nexport function shouldCheck(lastBlockNumber, tx) {\n  if (tx.receipt) return false;\n  if (!tx.lastCheckedBlockNumber) return true;\n  var blocksSinceCheck = lastBlockNumber - tx.lastCheckedBlockNumber;\n  if (blocksSinceCheck < 1) return false;\n  var minutesPending = (new Date().getTime() - tx.addedTime) / 1000 / 60;\n  if (minutesPending > 60) {\n    // every 10 blocks if pending for longer than an hour\n    return blocksSinceCheck > 9;\n  } else if (minutesPending > 5) {\n    // every 3 blocks if pending more than 5 minutes\n    return blocksSinceCheck > 2;\n  } else {\n    // otherwise every block\n    return true;\n  }\n}\nexport default function Updater() {\n  var _state$chainId;\n  var _useActiveWeb3React = useActiveWeb3React(),\n    chainId = _useActiveWeb3React.chainId,\n    library = _useActiveWeb3React.library;\n  var lastBlockNumber = useBlockNumber();\n  var dispatch = useDispatch();\n  var state = useSelector(function (state) {\n    return state.transactions;\n  });\n  var transactions = chainId ? (_state$chainId = state[chainId]) !== null && _state$chainId !== void 0 ? _state$chainId : {} : {};\n\n  // show popup on confirm\n  var addPopup = useAddPopup();\n  useEffect(function () {\n    if (!chainId || !library || !lastBlockNumber) return;\n    Object.keys(transactions).filter(function (hash) {\n      return shouldCheck(lastBlockNumber, transactions[hash]);\n    }).forEach(function (hash) {\n      library.getTransactionReceipt(hash).then(function (receipt) {\n        if (receipt) {\n          var _transactions$hash;\n          dispatch(finalizeTransaction({\n            chainId: chainId,\n            hash: hash,\n            receipt: {\n              blockHash: receipt.blockHash,\n              blockNumber: receipt.blockNumber,\n              contractAddress: receipt.contractAddress,\n              from: receipt.from,\n              status: receipt.status,\n              to: receipt.to,\n              transactionHash: receipt.transactionHash,\n              transactionIndex: receipt.transactionIndex\n            }\n          }));\n          addPopup({\n            txn: {\n              hash: hash,\n              success: receipt.status === 1,\n              summary: (_transactions$hash = transactions[hash]) === null || _transactions$hash === void 0 ? void 0 : _transactions$hash.summary\n            }\n          }, hash);\n        } else {\n          dispatch(checkedTransaction({\n            chainId: chainId,\n            hash: hash,\n            blockNumber: lastBlockNumber\n          }));\n        }\n      }).catch(function (error) {\n        console.error(\"failed to check transaction hash: \".concat(hash), error);\n      });\n    });\n  }, [chainId, library, transactions, lastBlockNumber, dispatch, addPopup]);\n  return null;\n}","map":{"version":3,"names":["useEffect","useDispatch","useSelector","useActiveWeb3React","useAddPopup","useBlockNumber","checkedTransaction","finalizeTransaction","shouldCheck","lastBlockNumber","tx","receipt","lastCheckedBlockNumber","blocksSinceCheck","minutesPending","Date","getTime","addedTime","Updater","_state$chainId","_useActiveWeb3React","chainId","library","dispatch","state","transactions","addPopup","Object","keys","filter","hash","forEach","getTransactionReceipt","then","_transactions$hash","blockHash","blockNumber","contractAddress","from","status","to","transactionHash","transactionIndex","txn","success","summary","catch","error","console","concat"],"sources":["E:/testprojects/CoolSwap-interface/src/state/transactions/updater.tsx"],"sourcesContent":["import { useEffect } from 'react';\r\nimport { useDispatch, useSelector } from 'react-redux';\r\nimport { useActiveWeb3React } from '../../hooks';\r\nimport { useAddPopup, useBlockNumber } from '../application/hooks';\r\nimport { AppDispatch, AppState } from '../index';\r\nimport { checkedTransaction, finalizeTransaction } from './actions';\r\n\r\nexport function shouldCheck(\r\n  lastBlockNumber: number,\r\n  tx: { addedTime: number; receipt?: {}; lastCheckedBlockNumber?: number }\r\n): boolean {\r\n  if (tx.receipt) return false;\r\n  if (!tx.lastCheckedBlockNumber) return true;\r\n  const blocksSinceCheck = lastBlockNumber - tx.lastCheckedBlockNumber;\r\n  if (blocksSinceCheck < 1) return false;\r\n  const minutesPending = (new Date().getTime() - tx.addedTime) / 1000 / 60;\r\n  if (minutesPending > 60) {\r\n    // every 10 blocks if pending for longer than an hour\r\n    return blocksSinceCheck > 9;\r\n  } else if (minutesPending > 5) {\r\n    // every 3 blocks if pending more than 5 minutes\r\n    return blocksSinceCheck > 2;\r\n  } else {\r\n    // otherwise every block\r\n    return true;\r\n  }\r\n}\r\n\r\nexport default function Updater(): null {\r\n  const { chainId, library } = useActiveWeb3React();\r\n\r\n  const lastBlockNumber = useBlockNumber();\r\n\r\n  const dispatch = useDispatch<AppDispatch>();\r\n  const state = useSelector<AppState, AppState['transactions']>((state) => state.transactions);\r\n\r\n  const transactions = chainId ? state[chainId] ?? {} : {};\r\n\r\n  // show popup on confirm\r\n  const addPopup = useAddPopup();\r\n\r\n  useEffect(() => {\r\n    if (!chainId || !library || !lastBlockNumber) return;\r\n\r\n    Object.keys(transactions)\r\n      .filter((hash) => shouldCheck(lastBlockNumber, transactions[hash]))\r\n      .forEach((hash) => {\r\n        library\r\n          .getTransactionReceipt(hash)\r\n          .then((receipt) => {\r\n            if (receipt) {\r\n              dispatch(\r\n                finalizeTransaction({\r\n                  chainId,\r\n                  hash,\r\n                  receipt: {\r\n                    blockHash: receipt.blockHash,\r\n                    blockNumber: receipt.blockNumber,\r\n                    contractAddress: receipt.contractAddress,\r\n                    from: receipt.from,\r\n                    status: receipt.status,\r\n                    to: receipt.to,\r\n                    transactionHash: receipt.transactionHash,\r\n                    transactionIndex: receipt.transactionIndex,\r\n                  },\r\n                })\r\n              );\r\n\r\n              addPopup(\r\n                {\r\n                  txn: {\r\n                    hash,\r\n                    success: receipt.status === 1,\r\n                    summary: transactions[hash]?.summary,\r\n                  },\r\n                },\r\n                hash\r\n              );\r\n            } else {\r\n              dispatch(checkedTransaction({ chainId, hash, blockNumber: lastBlockNumber }));\r\n            }\r\n          })\r\n          .catch((error) => {\r\n            console.error(`failed to check transaction hash: ${hash}`, error);\r\n          });\r\n      });\r\n  }, [chainId, library, transactions, lastBlockNumber, dispatch, addPopup]);\r\n\r\n  return null;\r\n}\r\n"],"mappings":"AAAA,SAASA,SAAS,QAAQ,OAAO;AACjC,SAASC,WAAW,EAAEC,WAAW,QAAQ,aAAa;AACtD,SAASC,kBAAkB,QAAQ,aAAa;AAChD,SAASC,WAAW,EAAEC,cAAc,QAAQ,sBAAsB;AAElE,SAASC,kBAAkB,EAAEC,mBAAmB,QAAQ,WAAW;AAEnE,OAAO,SAASC,WAAWA,CACzBC,eAAuB,EACvBC,EAAwE,EAC/D;EACT,IAAIA,EAAE,CAACC,OAAO,EAAE,OAAO,KAAK;EAC5B,IAAI,CAACD,EAAE,CAACE,sBAAsB,EAAE,OAAO,IAAI;EAC3C,IAAMC,gBAAgB,GAAGJ,eAAe,GAAGC,EAAE,CAACE,sBAAsB;EACpE,IAAIC,gBAAgB,GAAG,CAAC,EAAE,OAAO,KAAK;EACtC,IAAMC,cAAc,GAAG,CAAC,IAAIC,IAAI,CAAC,CAAC,CAACC,OAAO,CAAC,CAAC,GAAGN,EAAE,CAACO,SAAS,IAAI,IAAI,GAAG,EAAE;EACxE,IAAIH,cAAc,GAAG,EAAE,EAAE;IACvB;IACA,OAAOD,gBAAgB,GAAG,CAAC;EAC7B,CAAC,MAAM,IAAIC,cAAc,GAAG,CAAC,EAAE;IAC7B;IACA,OAAOD,gBAAgB,GAAG,CAAC;EAC7B,CAAC,MAAM;IACL;IACA,OAAO,IAAI;EACb;AACF;AAEA,eAAe,SAASK,OAAOA,CAAA,EAAS;EAAA,IAAAC,cAAA;EACtC,IAAAC,mBAAA,GAA6BjB,kBAAkB,CAAC,CAAC;IAAzCkB,OAAO,GAAAD,mBAAA,CAAPC,OAAO;IAAEC,OAAO,GAAAF,mBAAA,CAAPE,OAAO;EAExB,IAAMb,eAAe,GAAGJ,cAAc,CAAC,CAAC;EAExC,IAAMkB,QAAQ,GAAGtB,WAAW,CAAc,CAAC;EAC3C,IAAMuB,KAAK,GAAGtB,WAAW,CAAqC,UAACsB,KAAK;IAAA,OAAKA,KAAK,CAACC,YAAY;EAAA,EAAC;EAE5F,IAAMA,YAAY,GAAGJ,OAAO,IAAAF,cAAA,GAAGK,KAAK,CAACH,OAAO,CAAC,cAAAF,cAAA,cAAAA,cAAA,GAAI,CAAC,CAAC,GAAG,CAAC,CAAC;;EAExD;EACA,IAAMO,QAAQ,GAAGtB,WAAW,CAAC,CAAC;EAE9BJ,SAAS,CAAC,YAAM;IACd,IAAI,CAACqB,OAAO,IAAI,CAACC,OAAO,IAAI,CAACb,eAAe,EAAE;IAE9CkB,MAAM,CAACC,IAAI,CAACH,YAAY,CAAC,CACtBI,MAAM,CAAC,UAACC,IAAI;MAAA,OAAKtB,WAAW,CAACC,eAAe,EAAEgB,YAAY,CAACK,IAAI,CAAC,CAAC;IAAA,EAAC,CAClEC,OAAO,CAAC,UAACD,IAAI,EAAK;MACjBR,OAAO,CACJU,qBAAqB,CAACF,IAAI,CAAC,CAC3BG,IAAI,CAAC,UAACtB,OAAO,EAAK;QACjB,IAAIA,OAAO,EAAE;UAAA,IAAAuB,kBAAA;UACXX,QAAQ,CACNhB,mBAAmB,CAAC;YAClBc,OAAO,EAAPA,OAAO;YACPS,IAAI,EAAJA,IAAI;YACJnB,OAAO,EAAE;cACPwB,SAAS,EAAExB,OAAO,CAACwB,SAAS;cAC5BC,WAAW,EAAEzB,OAAO,CAACyB,WAAW;cAChCC,eAAe,EAAE1B,OAAO,CAAC0B,eAAe;cACxCC,IAAI,EAAE3B,OAAO,CAAC2B,IAAI;cAClBC,MAAM,EAAE5B,OAAO,CAAC4B,MAAM;cACtBC,EAAE,EAAE7B,OAAO,CAAC6B,EAAE;cACdC,eAAe,EAAE9B,OAAO,CAAC8B,eAAe;cACxCC,gBAAgB,EAAE/B,OAAO,CAAC+B;YAC5B;UACF,CAAC,CACH,CAAC;UAEDhB,QAAQ,CACN;YACEiB,GAAG,EAAE;cACHb,IAAI,EAAJA,IAAI;cACJc,OAAO,EAAEjC,OAAO,CAAC4B,MAAM,KAAK,CAAC;cAC7BM,OAAO,GAAAX,kBAAA,GAAET,YAAY,CAACK,IAAI,CAAC,cAAAI,kBAAA,uBAAlBA,kBAAA,CAAoBW;YAC/B;UACF,CAAC,EACDf,IACF,CAAC;QACH,CAAC,MAAM;UACLP,QAAQ,CAACjB,kBAAkB,CAAC;YAAEe,OAAO,EAAPA,OAAO;YAAES,IAAI,EAAJA,IAAI;YAAEM,WAAW,EAAE3B;UAAgB,CAAC,CAAC,CAAC;QAC/E;MACF,CAAC,CAAC,CACDqC,KAAK,CAAC,UAACC,KAAK,EAAK;QAChBC,OAAO,CAACD,KAAK,sCAAAE,MAAA,CAAsCnB,IAAI,GAAIiB,KAAK,CAAC;MACnE,CAAC,CAAC;IACN,CAAC,CAAC;EACN,CAAC,EAAE,CAAC1B,OAAO,EAAEC,OAAO,EAAEG,YAAY,EAAEhB,eAAe,EAAEc,QAAQ,EAAEG,QAAQ,CAAC,CAAC;EAEzE,OAAO,IAAI;AACb"},"metadata":{},"sourceType":"module"}